<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{.Product.Name}} - TechShop</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <style>
    .price{font-weight:700;color:#dc3545;font-size:1.2rem}
    .comment{border-bottom:1px solid #eee;padding:10px 0}
  </style>
</head>
<body class="bg-light">
  <div class="container py-4">
    <a href="/products" class="btn btn-link mb-3"><i class="fas fa-arrow-left"></i> Geri</a>

    <!-- Ürün bilgisi -->
    <div class="row">
      <div class="col-md-5">
        <img src="{{.Product.ImageURL}}" class="img-fluid rounded" alt="{{.Product.Name}}">
      </div>
      <div class="col-md-7">
        <h2>{{.Product.Name}}</h2>
        <p class="price">₺{{.Product.Price}}</p>
        <p>{{.Product.Description}}</p>
        <button class="btn btn-outline-success"><i class="fas fa-cart-plus"></i> Sepete Ekle</button>
      </div>
    </div>

    <!-- Hata mesajları (opsiyonel) -->
    {{if .ProductError}}
      <div class="alert alert-danger mt-4">Ürün Hatası: {{.ProductError}}</div>
    {{end}}
    {{if .CommentError}}
      <div class="alert alert-warning mt-2">Yorum Hatası: {{.CommentError}}</div>
    {{end}}

    <!-- Yorumlar -->
    <div class="mt-5">
      <h4>Yorumlar</h4>

      {{if .Comments}}
        {{range .Comments}}
          <div class="comment">
            <strong>{{.Author}}</strong>
            <div>{{.Content}}</div>
            <small class="text-muted">{{.CreatedAtStr}}</small>
          </div>
        {{end}}
      {{else}}
        <div class="text-muted">Henüz yorum yok.</div>
      {{end}}

      <!-- Yorum Ekle -->
      <form class="mt-3" action="/comment" method="post">
        <input type="hidden" name="product_id" value="{{.Product.ID.Int64}}">
        <div class="mb-2">
          <input name="author" class="form-control" placeholder="Adınız" required>
        </div>
        <div class="mb-2">
          <textarea name="content" class="form-control" placeholder="Yorumunuz"></textarea>
        </div>
        <button class="btn btn-primary">Gönder</button>
      </form>
    </div>
  </div>

   <!-- DOM XSS hedef alanı -->
    <div id="note" class="mt-3 text-muted"></div>

  <!-- insecure flag -->
  {{if .Secure}}
    <script>window.__INSECURE__ = false;</script>
  {{else}}
    <script>window.__INSECURE__ = true;</script>
  {{end}}

  <script>
    (function(){
      var insecure = (window.__INSECURE__ === true);

      function renderFromHash(){
        var v = decodeURIComponent(location.hash ? location.hash.slice(1) : "");
        var el = document.getElementById('note'); // sayfada yoksa sessizce çık
        if (!el) return;
        if (insecure) {
          el.innerHTML = v;   // INSECURE → DOM XSS
        } else {
          el.textContent = v; // SECURE → güvenli
        }
      }

      renderFromHash();
      window.addEventListener('hashchange', renderFromHash);
    })();
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
