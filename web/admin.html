<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8" />
  <title>Admin Paneli – TechShop</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link
    href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
    rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">

<nav class="navbar navbar-dark bg-dark shadow">
  <div class="container">
    <a class="navbar-brand" href="/dashboard.html">
      <i class="fas fa-tools me-2"></i>Admin Paneli
    </a>
  </div>
</nav>

<!-- Loading ekranı -->
<div id="loadingScreen" class="container py-4 text-center">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Yükleniyor...</span>
  </div>
  <p class="mt-3">Admin yetkisi kontrol ediliyor...</p>
</div>

<!-- Ana içerik - başlangıçta gizli -->
<div id="mainContent" class="container py-4" style="display: none;">
  <div class="row justify-content-center">
    <div class="col-lg-8">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title mb-3">
            <i class="fas fa-network-wired text-primary me-2"></i>
            Ping Çalıştır
          </h5>

          <div class="input-group mb-3">
            <span class="input-group-text">Target</span>
            <input id="target" class="form-control" placeholder="8.8.8.8 veya example.com" />
            <button id="btnPing" class="btn btn-primary">
              <i class="fas fa-play me-1"></i> Çalıştır
            </button>
          </div>

          <pre id="output" class="bg-black text-light p-3 rounded" style="min-height:180px; white-space:pre-wrap;"></pre>
        </div>
      </div>
    </div>
  </div>
</div>

<footer class="bg-dark text-light py-3 mt-5">
  <div class="container text-center">
    <small>&copy; 2024 TechShop Mağazası. Tüm hakları saklıdır.</small>
  </div>
</footer>

<script>
  // Sayfa yüklendiğinde admin kontrolü yap
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      const response = await fetch('/api/whoami');
      
      if (!response.ok) {
        // Login olmamış, ana sayfaya yönlendir
        window.location.href = '/index.html';
        return;
      }
      
      const user = await response.json();
      
      // Admin kontrolü
      if (user.role !== 'admin') {
        // Admin değil, dashboard'a yönlendir
        alert('Bu sayfaya erişim yetkiniz yok. Sadece adminler erişebilir.');
        window.location.href = '/dashboard.html';
        return;
      }
      
      // Admin ise içeriği göster
      document.getElementById('loadingScreen').style.display = 'none';
      document.getElementById('mainContent').style.display = 'block';
      
    } catch (error) {
      console.error('Yetkilendirme hatası:', error);
      // Hata durumunda ana sayfaya yönlendir
      window.location.href = '/index.html';
    }
  });

  // Ping butonu event listener'ını sadece sayfa yüklendikten sonra ekle
  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('btnPing').addEventListener('click', async () => {
      const target = document.getElementById('target').value.trim();
      const out = document.getElementById('output');
      out.textContent = "Çalıştırılıyor...\n";

      try {
        const resp = await fetch('/admin/ping', {
          method: 'POST',
          headers: {'Content-Type': 'application/json'},
          body: JSON.stringify({ target })
        });
        const data = await resp.json();
        if (!resp.ok) {
          out.textContent = (data && data.error) ? data.error : ('Hata: ' + resp.status);
        } else {
          out.textContent = data.output || '';
        }
      } catch (e) {
        out.textContent = 'İstek hatası: ' + e;
      }
    });
  });
</script>
</body>
</html>